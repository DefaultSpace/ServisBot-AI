<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ServisBot AI | thegptmind</title>
    <!-- Deployment Trigger: 2026-02-03 00:12 -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PWA & Mobile Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        :root {
            --primary: #3b82f6;
            --bg-dark: #020617;
            --card-bg: rgba(30, 41, 59, 0.7);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-dark);
            color: #f1f5f9;
            overflow-x: hidden;
            user-select: none;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .active-nav {
            color: var(--primary);
            transform: translateY(-2px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .btn-glow:active {
            transform: scale(0.96);
            filter: brightness(1.1);
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Header / Premium Tech Look -->
    <header class="p-6 pt-12 pb-6 sticky top-0 z-50 bg-[#020617]/80 backdrop-blur-2xl border-b border-white/5">
        <div class="flex justify-between items-center max-w-xl mx-auto">
            <div class="flex flex-col">
                <h1
                    class="text-2xl font-black tracking-tighter italic bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 bg-clip-text text-transparent">
                    SERVISBOT <span class="not-italic text-white">AI</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="connection-status"
                        class="h-2 w-2 rounded-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.6)] transition-all duration-500"></span>
                    <p id="technician-name-label"
                        class="text-[10px] text-slate-400 font-extrabold uppercase tracking-[0.2em]">YÜKLENİYOR...</p>
                </div>
            </div>
            <button onclick="app.switchPage('settings')"
                class="h-12 w-12 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center border border-white/10 text-blue-400 shadow-2xl active:scale-90 transition-all">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="max-w-xl mx-auto p-5 pb-40">

        <!-- PANEL SAYFASI (HOME) -->
        <div id="page-home" class="page-transition space-y-6">

            <!-- WhatsApp Hızlı İletişim -->
            <section class="glass-card rounded-[3rem] p-8 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-8 opacity-5 group-hover:opacity-10 transition-opacity">
                    <i data-lucide="message-circle" class="w-24 h-24 rotate-12"></i>
                </div>
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-green-500/20 rounded-2xl text-green-400 shadow-inner">
                        <i data-lucide="zap" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-xl font-extrabold text-white tracking-tight">Müşteri Ön Teşhis</h2>
                </div>

                <!-- Akıllı Hatırlatıcı / Not Uyarısı -->
                <div id="customer-reminder"
                    class="hidden mb-4 p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl animate-in fade-in slide-in-from-top-2">
                    <div class="flex items-center gap-3">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i>
                        <p id="reminder-text" class="text-[10px] font-black text-amber-200 uppercase tracking-tight">
                        </p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-4">MÜŞTERİ
                                ADI</label>
                            <input id="customerName" type="text" placeholder="Ad Soyad"
                                class="w-full bg-slate-950/50 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-white focus:border-blue-500 transition-all">
                        </div>
                        <div class="space-y-2">
                            <label
                                class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-4">TELEFON</label>
                            <input id="phoneInput" type="tel" placeholder="5xx xxx xx"
                                oninput="app.checkCustomerHistory(this.value)"
                                class="w-full bg-slate-950/50 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-white focus:border-blue-500 transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-4">CİHAZ
                                TİPİ</label>
                            <input id="deviceType" type="text" placeholder="Örn: Bulaşık Mak."
                                class="w-full bg-slate-950/50 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-white focus:border-blue-500 transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-4">SERVİS
                                ÜCRETİ</label>
                            <input id="serviceFee" type="text" placeholder="₺0.00"
                                class="w-full bg-slate-950/50 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-green-400 focus:border-green-500 transition-all">
                        </div>
                    </div>

                    <!-- Durum Butonları (Status Chips) -->
                    <div class="space-y-4">
                        <label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-4">İŞLEM
                            DURUMU</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="app.setStatus('COMING', this)"
                                class="status-chip p-4 rounded-2xl border border-white/5 bg-slate-900/40 text-[10px] font-black text-blue-400 flex flex-col items-center justify-center gap-2 transition-all hover:bg-blue-500/5 active:scale-95 group">
                                <i data-lucide="map-pin" class="w-4 h-4 group-hover:animate-bounce"></i> YOLDAYIM
                            </button>
                            <button onclick="app.setStatus('COMPLETED', this)"
                                class="status-chip p-4 rounded-2xl border border-white/5 bg-slate-900/40 text-[10px] font-black text-green-400 flex flex-col items-center justify-center gap-2 transition-all hover:bg-green-500/5 active:scale-95 group">
                                <i data-lucide="check-circle" class="w-4 h-4 group-hover:scale-110"></i> TAMAMLANDI
                            </button>
                            <button onclick="app.setStatus('PENDING_PART', this)"
                                class="status-chip p-4 rounded-2xl border border-white/5 bg-slate-900/40 text-[10px] font-black text-orange-400 flex flex-col items-center justify-center gap-2 transition-all hover:bg-orange-500/5 active:scale-95 group">
                                <i data-lucide="clock" class="w-4 h-4 group-hover:rotate-12"></i> PARÇA BEKLENİYOR
                            </button>
                            <button onclick="app.setStatus('WARRANTY', this)"
                                class="status-chip p-4 rounded-2xl border border-white/5 bg-slate-900/40 text-[10px] font-black text-purple-400 flex flex-col items-center justify-center gap-2 transition-all hover:bg-purple-500/5 active:scale-95 group">
                                <i data-lucide="shield-check" class="w-4 h-4 group-hover:animate-pulse"></i> GARANTİ
                            </button>
                            <button onclick="app.setStatus('SURVEY', this)"
                                class="status-chip p-4 rounded-2xl border border-white/5 bg-slate-900/40 text-[10px] font-black text-cyan-400 flex flex-col items-center justify-center gap-2 transition-all hover:bg-cyan-500/5 active:scale-95 group col-span-2">
                                <i data-lucide="star" class="w-4 h-4 group-hover:spin"></i> MEMNUNİYET ANKETİ
                            </button>
                        </div>
                        <input type="hidden" id="current-status" value="COMING">
                    </div>

                    <!-- Yumuşatılmış Dil Switch -->
                    <div
                        class="flex items-center justify-between p-4 bg-slate-900/40 rounded-2xl border border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-indigo-500/20 rounded-xl text-indigo-400">
                                <i data-lucide="heart" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-white uppercase tracking-tight">Yumuşatılmış Dil
                                </p>
                                <p class="text-[8px] text-slate-500 font-bold uppercase italic">Soft Tone Filtresi</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="tone-toggle" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>

                    <!-- Ek Detaylar (Gerektiğinde Açılır) -->
                    <div id="note-details" class="hidden space-y-3 pt-2">
                        <div class="grid grid-cols-2 gap-3">
                            <input id="note-enr" type="text" placeholder="MODEL (ENR) NO"
                                class="w-full bg-slate-950/30 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-slate-300 uppercase">
                            <input id="note-part" type="text" placeholder="DEĞİŞEN PARÇA"
                                class="w-full bg-slate-950/30 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-slate-300 uppercase">
                        </div>
                        <textarea id="note-content" placeholder="Ekteki detaylar veya özel notlar..."
                            class="w-full bg-slate-950/30 border border-white/5 p-4 rounded-2xl outline-none text-xs font-bold text-slate-300 h-20 resize-none"></textarea>
                    </div>

                    <div class="space-y-3 pb-2">
                        <button id="whatsapp-btn" onclick="app.sendWhatsApp()"
                            class="btn-glow w-full bg-blue-600 hover:bg-blue-500 h-16 rounded-3xl font-black text-sm flex items-center justify-center gap-3 shadow-[0_15px_30px_-5px_rgba(37,99,235,0.4)] transition-all uppercase tracking-tight">
                            WHATSAPP MESAJI GÖNDER <i data-lucide="message-square" class="w-5 h-5"></i>
                        </button>

                        <button onclick="app.setReminder()"
                            class="mb-3 w-full bg-slate-800/50 hover:bg-slate-800 h-12 rounded-2xl font-black text-[10px] text-slate-400 flex items-center justify-center gap-2 border border-white/5 transition-all uppercase tracking-widest">
                            <i data-lucide="bell-plus" class="w-4 h-4"></i> 48 Saat Sonra Hatırlat
                        </button>

                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="app.copyWhatsAppText()"
                                class="bg-indigo-600/20 hover:bg-indigo-600/30 text-indigo-400 h-14 rounded-2xl font-black text-[10px] flex items-center justify-center gap-2 border border-indigo-500/20 transition-all uppercase">
                                MESAJI KOPYALA <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.resetForm()"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-400 h-14 rounded-2xl font-black text-[10px] flex items-center justify-center gap-2 border border-white/5 transition-all uppercase">
                                FORMU SIFIRLA <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Hızlı Tekrar (Son 5 Mesaj) -->
                    <div id="quick-resend-area" class="hidden space-y-3 pt-6 border-t border-white/5">
                        <div class="flex items-center justify-between px-2">
                            <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest">HIZLI TEKRAR
                                (SON 5)</span>
                            <i data-lucide="zap" class="w-3 h-3 text-amber-500 animate-pulse"></i>
                        </div>
                        <div id="quick-resend-list" class="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
                            <!-- Son gönderilenler buraya gelecek -->
                        </div>
                    </div>

                    <button id="save-note-btn" onclick="app.saveCustomerNote()"
                        class="hidden w-full bg-white/5 border border-white/10 py-4 rounded-3xl font-black text-[10px] text-slate-400 uppercase tracking-widest hover:bg-green-500/10 hover:text-green-400 transition-all">
                        GÜNLÜĞE KAYDET
                    </button>
                </div>
            </section>

            <!-- Akıllı Arıza Sorgulama -->
            <section class="glass-card rounded-[3rem] p-8 shadow-2xl border-t border-white/10">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-blue-500/20 rounded-2xl text-blue-400">
                        <i data-lucide="search" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-xl font-extrabold text-white tracking-tight">Arıza Çözüm Merkezi</h2>
                </div>
                <div class="flex gap-3 mb-6">
                    <div class="flex-1 relative">
                        <input id="searchInput" type="text" placeholder="Hata kodu (Örn: E15)..."
                            class="w-full bg-slate-950/50 border border-white/5 p-5 pr-14 rounded-3xl outline-none focus:border-blue-500 transition-all font-bold text-lg">
                        <button onclick="app.startVoiceSearch()"
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-blue-400 active:scale-90 transition-all">
                            <i data-lucide="mic" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <button onclick="app.searchSheets()"
                        class="bg-indigo-600 p-5 rounded-3xl w-16 flex items-center justify-center btn-glow shadow-xl shadow-indigo-900/40">
                        <i data-lucide="search" class="w-7 h-7 text-white"></i>
                    </button>
                </div>

                <!-- Dinamik Sonuç Alanı -->
                <div id="results" class="space-y-4 transition-all duration-500"></div>

                <!-- AI Desteği -->
                <button onclick="app.askGemini()"
                    class="mt-6 w-full bg-white/5 border border-white/10 py-5 rounded-3xl font-black flex items-center justify-center gap-3 transition-all hover:bg-white/10 active:scale-95 text-indigo-300 tracking-wide">
                    <i data-lucide="sparkles" class="w-5 h-5 animate-pulse"></i> GEMINI AI'YA DANIŞ
                </button>
            </section>
        </div>

        <!-- GEÇMİŞ SAYFASI -->
        <div id="page-history" class="hidden page-transition space-y-6">
            <div class="flex justify-between items-center px-4">
                <h2 class="text-3xl font-black tracking-tighter italic">GEÇMİŞ <span
                        class="text-blue-500">KAYITLAR</span></h2>
                <div class="flex gap-2">
                    <button onclick="app.showCustomers()"
                        class="text-[10px] font-black text-green-400 uppercase tracking-widest bg-green-500/10 px-4 py-2 rounded-full border border-green-500/20 active:scale-90 transition-all">Müşteriler</button>
                    <button onclick="app.clearHistory()"
                        class="text-[10px] font-black text-red-400 uppercase tracking-widest bg-red-500/10 px-4 py-2 rounded-full border border-red-500/20 active:scale-90 transition-all">Temizle</button>
                </div>
            </div>
            <div id="historyList" class="space-y-4"></div>
        </div>

        <!-- ARAÇLAR SAYFASI -->
        <div id="page-docs" class="hidden page-transition space-y-8">
            <h2 class="text-3xl font-black italic px-4 text-white uppercase tracking-tighter leading-none">TEKNİK
                <br><span class="text-blue-500">CEPHANELİK</span>
            </h2>
            <div class="grid grid-cols-1 gap-5 px-2">
                <div onclick="app.switchPage('testmode')"
                    class="glass-card p-7 rounded-[2.5rem] border-blue-500/10 flex items-center gap-5 group cursor-pointer active:scale-95 transition-all">
                    <div
                        class="p-4 bg-blue-500/10 rounded-[1.5rem] text-blue-400 group-hover:scale-110 transition-transform">
                        <i data-lucide="terminal" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-lg">Hata Kodları Rehberi</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">ARIZA KODU KÜTÜPHANESİ
                        </p>
                    </div>
                </div>
                <div onclick="app.switchPage('spareparts')"
                    class="glass-card p-7 rounded-[2.5rem] border-orange-500/10 flex items-center gap-5 group cursor-pointer active:scale-95 transition-all">
                    <div
                        class="p-4 bg-orange-500/10 rounded-[1.5rem] text-orange-400 group-hover:scale-110 transition-transform">
                        <i data-lucide="package-search" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-lg">Yedek Parça Kütüphanesi</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">MODEL BAZLI PARÇA
                            LİSTESİ
                        </p>
                    </div>
                </div>
                <div onclick="app.switchPage('testcodes')"
                    class="glass-card p-7 rounded-[2.5rem] border-purple-500/10 flex items-center gap-5 group cursor-pointer active:scale-95 transition-all">
                    <div
                        class="p-4 bg-purple-500/10 rounded-[1.5rem] text-purple-400 group-hover:scale-110 transition-transform">
                        <i data-lucide="file-text" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-lg">Test Modları</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Cihaz Gizli Menüleri
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEST MODU SAYFASI -->
        <div id="page-testmode" class="hidden page-transition space-y-6">
            <div class="flex items-center gap-3 px-4">
                <button onclick="app.switchPage('docs')"
                    class="p-2 bg-white/5 rounded-2xl active:scale-90 transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-blue-400"></i>
                </button>
                <h2 class="text-3xl font-black italic text-white uppercase tracking-tighter leading-none">HATA KODLARI
                    <br><span class="text-blue-500">REHBERİ</span>
                </h2>
            </div>

            <!-- MODEL ARAMA -->
            <section class="glass-card rounded-[2.5rem] p-8 border-t border-green-500/10">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-green-500/20 rounded-2xl text-green-400">
                        <i data-lucide="search" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-white">MODEL SORGULA</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Cihaz Modeline Özel
                            Talimat</p>
                    </div>
                </div>

                <div class="flex gap-3 mb-4">
                    <input id="testModeSearchInput" type="text"
                        placeholder="Model numarası veya cihaz tipi (örn: WGA142X0TR)"
                        class="flex-1 bg-slate-950/50 border border-white/5 p-5 rounded-3xl outline-none focus:border-green-500 transition-all font-bold text-lg">
                    <button onclick="app.searchTestMode()"
                        class="bg-green-600 p-5 rounded-3xl w-16 flex items-center justify-center btn-glow shadow-xl shadow-green-900/40">
                        <i data-lucide="search" class="w-7 h-7 text-white"></i>
                    </button>
                </div>

                <!-- Arama Sonuçları -->
                <div id="testModeResults" class="space-y-4"></div>
            </section>
        </div>

        <!-- TEST KODLARI SAYFASI (YENİ) -->
        <div id="page-testcodes" class="hidden page-transition space-y-6">
            <div class="flex items-center gap-3 px-4">
                <button onclick="app.switchPage('docs')"
                    class="p-2 bg-white/5 rounded-2xl active:scale-90 transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-orange-400"></i>
                </button>
                <h2 class="text-3xl font-black italic text-white uppercase tracking-tighter leading-none">TEST
                    <br><span class="text-orange-500">MODLARI</span>
                </h2>
            </div>

            <!-- KATEGORİ SEÇİMİ -->
            <section class="grid grid-cols-3 gap-3 px-2">
                <button onclick="app.loadTestCodes('Çamaşır')"
                    class="glass-card p-4 rounded-3xl flex flex-col items-center gap-2 border-orange-500/10 active:scale-95 transition-all group">
                    <div
                        class="p-3 bg-orange-500/10 rounded-2xl text-orange-400 group-hover:scale-110 transition-transform">
                        <i data-lucide="layers" class="w-6 h-6"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-slate-400">Çamaşır</span>
                </button>
                <button onclick="app.loadTestCodes('Bulaşık')"
                    class="glass-card p-4 rounded-3xl flex flex-col items-center gap-2 border-orange-500/10 active:scale-95 transition-all group">
                    <div
                        class="p-3 bg-orange-500/10 rounded-2xl text-orange-400 group-hover:scale-110 transition-transform">
                        <i data-lucide="utensils" class="w-6 h-6"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-slate-400">Bulaşık</span>
                </button>
                <button onclick="app.loadTestCodes('Kurutma')"
                    class="glass-card p-4 rounded-3xl flex flex-col items-center gap-2 border-orange-500/10 active:scale-95 transition-all group">
                    <div
                        class="p-3 bg-orange-500/10 rounded-2xl text-orange-400 group-hover:scale-110 transition-transform">
                        <i data-lucide="wind" class="w-6 h-6"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-slate-400">Kurutma</span>
                </button>
            </section>

            <!-- Test Kodları Listesi -->
            <div id="testCodesResults" class="space-y-4 px-2">
                <div class="p-12 text-center opacity-30">
                    <i data-lucide="mouse-pointer-2" class="w-12 h-12 mx-auto mb-4 animate-bounce"></i>
                    <p class="text-[10px] font-black uppercase tracking-widest">Cihaz Grubu Seç</p>
                </div>
            </div>
        </div>

        <!-- PROFİL SAYFASI -->
        <div id="page-profile" class="hidden page-transition space-y-8 px-4">
            <div class="flex flex-col items-center text-center space-y-4 py-8">
                <div class="relative">
                    <div
                        class="w-32 h-32 rounded-[3rem] bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center border-4 border-white/10 shadow-2xl">
                        <i data-lucide="user" class="w-16 h-16 text-white"></i>
                    </div>
                    <div
                        class="absolute -bottom-2 -right-2 bg-green-500 w-10 h-10 rounded-2xl flex items-center justify-center border-4 border-[#020617] text-white">
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </div>
                </div>
                <div>
                    <h2 id="profile-tech-name" class="text-3xl font-black text-white tracking-tighter italic">TEKNİSYEN
                    </h2>
                    <p class="text-[10px] text-blue-400 font-bold uppercase tracking-[0.3em] mt-1">Sertifikalı Uzman</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-6 rounded-[2.5rem] border-blue-500/10 text-center">
                    <span id="stat-addresses" class="text-3xl font-black text-white block">0</span>
                    <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Adres Sayısı</span>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border-orange-500/10 text-center">
                    <span id="stat-parts" class="text-3xl font-black text-white block">0</span>
                    <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Değişen Parça</span>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border-green-500/10 text-center">
                    <span id="stat-customers" class="text-3xl font-black text-green-400 block">0</span>
                    <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Kayıtlı Müşteri</span>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border-purple-500/10 text-center">
                    <span id="stat-lib-parts" class="text-3xl font-black text-white block">0</span>
                    <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Kütüphane Parça</span>
                </div>
            </div>

            <!-- Customer List Modal Overlay -->
            <div id="customer-list-modal"
                class="hidden fixed inset-0 z-[200] bg-[#020617]/95 backdrop-blur-xl animate-in fade-in duration-300 overflow-y-auto">
                <div class="p-6 pb-20 max-w-xl mx-auto">
                    <div class="flex justify-between items-center mb-8 sticky top-0 bg-[#020617]/80 py-4 z-10">
                        <div>
                            <h2 class="text-2xl font-black italic text-white uppercase tracking-tighter">KAYITLI <span
                                    class="text-green-500">MÜŞTERİLER</span></h2>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Sistemdeki
                                Tüm Kayıtlar</p>
                        </div>
                        <button onclick="document.getElementById('customer-list-modal').classList.add('hidden')"
                            class="p-3 bg-white/5 rounded-2xl text-slate-400 hover:text-white transition-colors">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div id="customer-list-container" class="space-y-4">
                        <!-- Customers will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- History Detail Modal -->
            <div id="history-detail-modal"
                class="hidden fixed inset-0 z-[200] bg-[#020617]/95 backdrop-blur-xl animate-in fade-in duration-300 flex items-center justify-center px-4">
                <div
                    class="bg-[#0f172a] border border-white/10 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl relative">
                    <button onclick="document.getElementById('history-detail-modal').classList.add('hidden')"
                        class="absolute top-6 right-6 p-2 bg-white/5 rounded-full text-slate-400 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>

                    <div class="text-center mb-6">
                        <div
                            class="w-16 h-16 bg-blue-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-400">
                            <i data-lucide="file-text" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-black text-white tracking-tight uppercase">İşlem Detayı</h3>
                        <p id="modal-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">
                            ...</p>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span
                                class="text-[8px] text-slate-500 font-black uppercase tracking-widest block mb-1">Müşteri</span>
                            <p id="modal-client" class="text-sm font-bold text-white">...</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                                <span
                                    class="text-[8px] text-slate-500 font-black uppercase tracking-widest block mb-1">Cihaz</span>
                                <p id="modal-device" class="text-xs font-bold text-slate-300">...</p>
                            </div>
                            <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                                <span
                                    class="text-[8px] text-slate-500 font-black uppercase tracking-widest block mb-1">Durum</span>
                                <p id="modal-type" class="text-xs font-bold text-slate-300">...</p>
                            </div>
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest block mb-1">Not
                                / Detay</span>
                            <p id="modal-note" class="text-xs font-medium text-slate-400 leading-relaxed">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="app.resetStats()"
                class="w-full py-4 rounded-3xl border border-white/5 text-[10px] font-black text-slate-600 uppercase tracking-widest hover:text-red-400 hover:bg-red-500/5 transition-all">
                Aylık Metrikleri Sıfırla
            </button>
        </div>

        <!-- YEDEK PARÇA SAYFASI -->
        <div id="page-spareparts" class="hidden page-transition space-y-6">
            <div class="flex items-center gap-3 px-4">
                <button onclick="app.switchPage('docs')"
                    class="p-2 bg-white/5 rounded-2xl active:scale-90 transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-orange-400"></i>
                </button>
                <h2 class="text-3xl font-black italic text-white uppercase tracking-tighter leading-none">YEDEK PARÇA
                    <br><span class="text-orange-500">KÜTÜPHANESİ</span>
                </h2>
            </div>

            <!-- PARÇA ARAMA -->
            <section class="glass-card rounded-[2.5rem] p-8 border-t border-orange-500/10">
                <div class="flex items-center gap-4 mb-6">
                    <div class="p-3 bg-orange-500/20 rounded-2xl text-orange-400">
                        <i data-lucide="package-search" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-white">MODEL BAZLI ARA</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Kayıtlı Parça Listesi
                        </p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <input id="libSearchInput" type="text" placeholder="Model No (Örn: SMS44DI00T)"
                        oninput="app.libSearch()"
                        class="flex-1 bg-slate-950/50 border border-white/5 p-5 rounded-3xl outline-none focus:border-orange-500 transition-all font-bold text-lg text-orange-100">
                </div>

                <div id="libResults" class="mt-6 space-y-4">
                    <div class="p-12 text-center opacity-30">
                        <i data-lucide="search" class="w-12 h-12 mx-auto mb-4"></i>
                        <p class="text-[10px] font-black uppercase tracking-widest">Model Numarası Gir</p>
                    </div>
                </div>
            </section>

            <!-- YENİ PARÇA EKLE -->
            <section class="glass-card rounded-[2.5rem] p-8 border-t border-white/5 space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-4">KARTINDAKİ PARÇAYI EKLE
                </h3>

                <div class="space-y-3">
                    <input id="lib-model" type="text" placeholder="MODEL NO"
                        class="w-full bg-slate-950/30 border border-white/5 p-4 rounded-2xl text-xs font-bold text-white uppercase">
                    <input id="lib-name" type="text" placeholder="PARÇA İSMİ (Pompa, Isıtıcı vs.)"
                        class="w-full bg-slate-950/30 border border-white/5 p-4 rounded-2xl text-xs font-bold text-white uppercase">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="lib-code" type="text" placeholder="PARÇA KODU"
                            class="bg-slate-950/30 border border-white/5 p-4 rounded-2xl text-xs font-bold text-white uppercase">
                        <input id="lib-price" type="text" placeholder="FİYAT (OPSİYONEL)"
                            class="bg-slate-950/30 border border-white/5 p-4 rounded-2xl text-xs font-bold text-white uppercase">
                    </div>
                </div>

                <button onclick="app.libAddPart()"
                    class="w-full bg-orange-600 hover:bg-orange-500 py-5 rounded-3xl font-black text-sm flex items-center justify-center gap-3 transition-all">
                    KÜTÜPHANEYE KAYDET <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </section>
        </div>

        <!-- AYARLAR SAYFASI -->
        <div id="page-settings" class="hidden page-transition space-y-8 px-4">
            <h2 class="text-3xl font-black italic text-white uppercase tracking-tighter leading-none">UYGULAMA
                <br><span class="text-blue-500">AYARLARI</span>
            </h2>

            <section class="glass-card rounded-[2.5rem] p-8 space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-4">Teknisyen
                        Adı</label>
                    <input id="setting-tech-name" type="text" placeholder="Adınız Soyadınız"
                        class="w-full bg-slate-950/50 border border-white/5 p-5 rounded-3xl outline-none focus:border-blue-500 transition-all font-bold">
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-4">Gemini API
                        Anahtarı</label>
                    <div class="relative">
                        <input id="setting-api-key" type="password" placeholder="AIza..."
                            class="w-full bg-slate-950/50 border border-white/5 p-5 rounded-3xl outline-none focus:border-blue-500 transition-all font-bold">
                        <button onclick="app.togglePassword('setting-api-key')"
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <button onclick="app.saveSettings()"
                    class="btn-glow w-full bg-blue-600 hover:bg-blue-500 py-5 rounded-3xl font-black text-sm flex items-center justify-center gap-3 shadow-xl transition-all">
                    DEĞİŞİKLİKLERİ KAYDET <i data-lucide="save" class="w-5 h-5"></i>
                </button>
            </section>

            <section class="p-4 text-center">
                <p class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">Software Version 2.0.0</p>
                <p class="text-[8px] text-slate-700 mt-1 uppercase">Coded for Hüseyin Emrehan</p>
            </section>
        </div>

    </main>

    <!-- Navigation / Floating Bar Style -->
    <div class="fixed bottom-8 left-0 right-0 z-[100] px-6 max-w-xl mx-auto">
        <nav
            class="glass-card border border-white/10 rounded-[2.5rem] p-4 flex justify-around items-center shadow-[0_20px_60px_-15px_rgba(0,0,0,0.8)]">
            <button onclick="app.switchPage('home')" id="nav-home"
                class="flex flex-col items-center gap-1 active-nav p-2">
                <i data-lucide="layout-grid" class="w-7 h-7"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Panel</span>
            </button>
            <button onclick="app.switchPage('history')" id="nav-history"
                class="flex flex-col items-center gap-1 text-slate-500 p-2">
                <i data-lucide="history" class="w-7 h-7"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Geçmiş</span>
            </button>
            <button onclick="app.switchPage('docs')" id="nav-docs"
                class="flex flex-col items-center gap-1 text-slate-500 p-2">
                <i data-lucide="library" class="w-7 h-7"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Araçlar</span>
            </button>
            <button onclick="app.switchPage('profile')" id="nav-profile"
                class="flex flex-col items-center gap-1 text-slate-500 p-2">
                <i data-lucide="user" class="w-7 h-7"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Profil</span>
            </button>
        </nav>
    </div>

    <script>
        /**
         * SERVISBOT AI - thegptmind Core Logic
         * Coded for Hüseyin Emrehan
         */
        const app = {
            config: {
                sheetsUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTu7chlLMcGpcFVDYs5ZxUbyBv5K2xG6P45g9R4wPEMppvCYuW-VFlVfRdbI9YFhKTV5CgAW7ucISPA/pub?output=csv",
                testModeCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBikgHcu8GzaZNP43ee4jz-UzR3mJRQKoQS0b7ofdv5KRx4wKISiIsSEMP_Xlq_CtAPsEFvmQYtHZZ/pub?output=csv",
                testCodesCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQO0uwM4KwTQC0qlylwzk-p128PzoQbeJNZAKnuQibAu5AGc5Q7IP_goXdS9emabh7DgIYPnxHoXCFG/pub?output=csv",
                storageKey: "servisbot_pro_v1",
                settingsKey: "servisbot_settings_v1",
                dataCacheKey: "servisbot_data_cache_v1",
                customersKey: "servisbot_customers_v1",
                partsLibKey: "servisbot_parts_v1",
                statsKey: "servisbot_stats_v1",
                lastSentKey: "servisbot_last_sent_v1",
                remindersKey: "servisbot_reminders_v1"
            },

            messageTemplates: {
                COMING: {
                    normal: "Selam, ben Bosch Siemens Profilo servis teknisyeni {tech}. {client} için {device} arızasıyla ilgili yaklaşık 1 saat içinde adresinizde olacağım. Arızayı önceden analiz edebilmem için cihazın ekranındaki hata kodunu veya arızanın kısa bir videosunu buraya atabilir misiniz?",
                    soft: "Merhabalar, ben Bosch Siemens Profilo servis merkezinden {tech}. Değerli vaktinizi ayırdığınız için teşekkürler. {client} adına kayıtlı olan {device} cihazınız için yaklaşıp 1 saat içinde yanınızda olmayı planlıyorum. Size daha hızlı yardımcı olabilmem adına, arızayı gösteren küçük bir video veya hata kodunu paylaşabilir misiniz? Şimdiden teşekkürler."
                },
                COMPLETED: {
                    normal: "Sayın {client}, {device} cihazınızın onarımı tamamlanmıştır. Yapılan işlem sonucunda belirlenen servis bedeli {price} olarak güncellenmiştir. İyi günler dileriz.",
                    soft: "Değerli müşterimiz {client}, {device} cihazınızın bakım ve onarım işlemleri titizlikle tamamlanmıştır. Cihazınızı sağlıklı günlerde kullanmanızı dileriz. İşlem bedeli {price} olarak belirlenmiştir. Bizi tercih ettiğiniz için teşekkür ederiz."
                },
                PENDING_PART: {
                    normal: "Sayın {client}, {device} cihazınız için gerekli olan yedek parça siparişi verilmiştir. Parça ulaştığında sizinle randevu için tekrar iletişime geçeceğiz. Sabrınız için teşekkürler.",
                    soft: "Sayın {client}, {device} cihazınızın tam performansla çalışabilmesi için orijinal parça siparişini sisteme geçtik. Parçamız elimize ulaşır ulaşmaz sizi bekletmeden randevu oluşturacağız. Gösterdiğiniz anlayış için çok teşekkür ederiz."
                },
                WARRANTY: {
                    normal: "Sayın {client}, {device} cihazınızdaki işlem garanti kapsamında değerlendirilmiştir. Herhangi bir ek ücret yansıtılmayacaktır. İyi günler dileriz.",
                    soft: "Değerli müşterimiz {client}, yaptığımız inceleme sonucunda {device} cihazınızdaki işlemin garanti şartları dahilinde olduğunu belirledik. Sizden herhangi bir servis bedeli talep edilmeyecektir. Sizin memnuniyetiniz bizim için önemli."
                },
                SURVEY: {
                    normal: "Merhaba ben teknisyeniniz {tech}. Geçtiğimiz günlerde adresinizde gelip {device} cihazınız için servis hizmeti sağlamıştım. Telefonunuza mesajlar kısmından bir anket gelmiş olmalı, eğer hizmetimizden memnun kaldıysanız bize 10 puan vererek destek olur musunuz? Bu bizim için çok değerli. Cihazla ilgili bir sorunuz olursa bu numaradan bana ulaşabilirsiniz. İyi günler dilerim.",
                    soft: "Değerli müşterimiz, ben teknisyeniniz {tech}. {device} cihazınız için gerçekleştirdiğimiz servis ziyaretimizle ilgili memnuniyetinizi ölçmek adına telefonunuza bir anket iletilecektir. Eğer sizi memnun edebildiysek anket üzerinden bize 10 puan verebilir misiniz? Desteğiniz bizim için çok kıymetli. Cihazınızla ilgili her türlü sorununuzda bu hattan bana doğrudan ulaşabilirsiniz. İyi günler dilerim."
                }
            },

            setStatus: function (status, btn) {
                document.getElementById('current-status').value = status;
                document.querySelectorAll('.status-chip').forEach(b => {
                    b.classList.remove('bg-blue-600', 'bg-green-600', 'bg-orange-600', 'bg-purple-600', 'text-white');
                    b.classList.add('bg-slate-900/40');
                });

                const colors = {
                    COMING: 'bg-blue-600',
                    COMPLETED: 'bg-green-600',
                    PENDING_PART: 'bg-orange-600',
                    WARRANTY: 'bg-purple-600',
                    SURVEY: 'bg-cyan-600'
                };

                btn.classList.remove('bg-slate-900/40');
                btn.classList.add(colors[status], 'text-white');
            },

            init: function () {
                lucide.createIcons();
                this.loadSettings();
                this.loadStats();
                this.renderHistory();
                this.renderLastSent();
                this.syncOfflineData();
                this.updateConnectionStatus();
                window.addEventListener('online', () => this.updateConnectionStatus());
                window.addEventListener('offline', () => this.updateConnectionStatus());

                // Bildirim kontrolü başlat (Her 30 saniyede bir)
                this.checkReminders();
                setInterval(() => this.checkReminders(), 30000);

                // Bildirim izni iste
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            },

            updateConnectionStatus: function () {
                const statusDots = document.getElementById('connection-status');
                if (navigator.onLine) {
                    statusDots.classList.remove('bg-slate-500');
                    statusDots.classList.add('bg-blue-500', 'animate-pulse');
                    this.syncOfflineData();
                } else {
                    statusDots.classList.remove('bg-blue-500', 'animate-pulse');
                    statusDots.classList.add('bg-slate-500');
                }
            },

            syncOfflineData: function () {
                // Çevrimdışı verileri senkronize et (Gelecekte genişletilebilir)
                console.log("ServisBot AI - Çevrimdışı Senkronizasyon Kontrolü");
            },

            /**
             * Merkezi veri çekme fonksiyonu - Proxy ve Cache desteği ile
             */
            fetchWithFallback: async function (baseUrl, timeout = 6000) {
                const attempts = [
                    baseUrl,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(baseUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(baseUrl)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(baseUrl)}`
                ];

                for (const url of attempts) {
                    try {
                        const response = await fetch(url, { signal: AbortSignal.timeout(timeout) });
                        if (response.ok) {
                            const text = await response.text();
                            // Cache update only for main sheetsUrl
                            if (baseUrl === this.config.sheetsUrl) {
                                localStorage.setItem(this.config.dataCacheKey, text);
                            }
                            return text;
                        }
                    } catch (e) {
                        console.warn(`Bağlantı denemesi başarısız (${url.substring(0, 40)}...):`, e.message);
                    }
                }

                // İnternet yoksa veya fetch başarısızsa cache'den al (sadece ana arıza sorgusu için)
                if (baseUrl === this.config.sheetsUrl) {
                    const cached = localStorage.getItem(this.config.dataCacheKey);
                    if (cached) return cached;
                }

                throw new Error("Veri yüklenemedi. İnternet bağlantını kontrol et usta.");
            },

            /**
             * Karmaşık CSV ayrıştırma (Tırnak içindeki yeni satırları ve virgülleri korur)
             */
            parseCSV: function (text) {
                const rows = [];
                let currentRow = [];
                let currentField = '';
                let insideQuotes = false;

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];

                    if (char === '"' && insideQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        currentRow.push(currentField);
                        currentField = '';
                    } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                        if (currentRow.length > 0 || currentField !== '') {
                            currentRow.push(currentField);
                            rows.push(currentRow);
                            currentRow = [];
                            currentField = '';
                        }
                        if (char === '\r' && nextChar === '\n') i++;
                    } else {
                        currentField += char;
                    }
                }
                if (currentRow.length > 0 || currentField !== '') {
                    currentRow.push(currentField);
                    rows.push(currentRow);
                }
                return rows;
            },

            checkCustomerHistory: function (val) {
                const phone = val.replace(/\D/g, '');
                const reminder = document.getElementById('customer-reminder');
                const noteDetails = document.getElementById('note-details');
                const saveBtn = document.getElementById('save-note-btn');

                if (phone.length >= 10) {
                    const customers = JSON.parse(localStorage.getItem(this.config.customersKey) || "{}");
                    const prevNote = customers[phone];

                    noteDetails.classList.remove('hidden');
                    saveBtn.classList.remove('hidden');

                    if (prevNote) {
                        reminder.classList.remove('hidden');
                        document.getElementById('reminder-text').textContent = `ÖNCEKİ KAYIT: ${prevNote.enr || 'Bilinmiyor'} - ${prevNote.status}`;
                        // Formu doldur
                        document.getElementById('customerName').value = prevNote.name || '';
                        document.getElementById('deviceType').value = prevNote.device || '';
                        document.getElementById('note-enr').value = prevNote.enr || '';
                        document.getElementById('note-part').value = prevNote.changedPart || '';
                        document.getElementById('note-content').value = prevNote.content || '';

                        // Status sync
                        this.setStatus(prevNote.status, document.querySelector(`[onclick*="${prevNote.status}"]`));
                    } else {
                        reminder.classList.add('hidden');
                    }
                } else {
                    reminder.classList.add('hidden');
                    noteDetails.classList.add('hidden');
                    saveBtn.classList.add('hidden');
                }
            },

            saveCustomerNote: function () {
                const phoneInput = document.getElementById('phoneInput');
                const phone = phoneInput.value.replace(/\D/g, '');
                const name = document.getElementById('customerName').value.trim();
                const device = document.getElementById('deviceType').value.trim();
                const fee = document.getElementById('serviceFee').value.trim();
                const status = document.getElementById('current-status').value;
                const enr = document.getElementById('note-enr').value.trim();
                const changedPart = document.getElementById('note-part').value.trim();
                const content = document.getElementById('note-content').value.trim();

                if (phone.length < 10) {
                    alert("Numara eksik usta!");
                    return;
                }

                const customers = JSON.parse(localStorage.getItem(this.config.customersKey) || "{}");
                customers[phone] = {
                    name, device, fee, status, enr, changedPart, content,
                    date: new Date().toLocaleDateString('tr-TR'),
                    tech: this.settings.techName
                };

                localStorage.setItem(this.config.customersKey, JSON.stringify(customers));
                this.saveToHistory('📋 Kayıt', `${name || phone} - ${status}`);

                if (status === 'COMPLETED') {
                    this.incrementStat('addresses');
                    if (document.getElementById('note-part').value.trim()) {
                        this.incrementStat('partsChanged');
                    }
                }

                alert("Kayıt başarıyla günlüğe eklendi.");
                this.loadStats();
                // Opsiyonel: Kayıt sonrası temizle? Kullanıcı "Sıfırla" istiyordu, kalsın mı silinsin mi?
                // Müşteri "isimler hala orada kalıyor, sıfırla butonu istiyorum" demişti. 
                // Belki kayıttan sonra da sıfırlamak otomatik olabilir. Ama manuel buton şimdilik öncelik.
            },

            resetForm: function () {
                document.getElementById('customerName').value = '';
                document.getElementById('phoneInput').value = '';
                document.getElementById('deviceType').value = '';
                document.getElementById('serviceFee').value = '';
                document.getElementById('note-enr').value = '';
                document.getElementById('note-part').value = '';
                document.getElementById('note-content').value = '';
                document.getElementById('customer-reminder').classList.add('hidden');
                document.getElementById('note-details').classList.add('hidden');
                document.getElementById('save-note-btn').classList.add('hidden');

                // Status reset to default
                this.setStatus('COMING', document.querySelector('[onclick*="COMING"]'));

                alert("Form tertemiz oldu usta!");
            },

            showCustomers: function () {
                const modal = document.getElementById('customer-list-modal');
                const container = document.getElementById('customer-list-container');
                const customers = JSON.parse(localStorage.getItem(this.config.customersKey) || "{}");

                modal.classList.remove('hidden');

                if (Object.keys(customers).length === 0) {
                    container.innerHTML = `
                        <div class="p-20 text-center opacity-30">
                            <i data-lucide="users" class="w-16 h-16 mx-auto mb-4"></i>
                            <p class="text-xs font-black uppercase tracking-widest">Henüz Kayıtlı Müşteri Yok</p>
                        </div>`;
                    lucide.createIcons();
                    return;
                }

                // Sort by date (descending) - this is approximate as we only have string dates
                const sortedKeys = Object.keys(customers).reverse();

                container.innerHTML = sortedKeys.map(phone => {
                    const c = customers[phone];
                    const statusColor = {
                        COMING: 'text-blue-400 bg-blue-500/10',
                        COMPLETED: 'text-green-400 bg-green-500/10',
                        PENDING_PART: 'text-orange-400 bg-orange-500/10',
                        WARRANTY: 'text-purple-400 bg-purple-500/10'
                    }[c.status] || 'text-slate-400 bg-slate-500/10';

                    return `
                        <div class="glass-card p-6 rounded-[2.5rem] border-l-4 ${statusColor.split(' ')[0].replace('text', 'border')} space-y-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-black text-white tracking-tight leading-none">${c.name || 'İsimsiz Müşteri'}</h3>
                                    <p class="text-xs font-bold text-slate-500 mt-1">${phone}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest ${statusColor}">
                                    ${c.status}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-slate-900/40 p-3 rounded-2xl border border-white/5">
                                    <span class="text-[7px] text-slate-500 font-black uppercase block mb-1">Cihaz / Model</span>
                                    <p class="text-[10px] font-bold text-slate-300 text-ellipsis overflow-hidden">${c.device || '-'} ${c.enr ? `(${c.enr})` : ''}</p>
                                </div>
                                <div class="bg-slate-900/40 p-3 rounded-2xl border border-white/5">
                                    <span class="text-[7px] text-slate-500 font-black uppercase block mb-1">Değişen Parça</span>
                                    <p class="text-[10px] font-bold text-orange-400 text-ellipsis overflow-hidden">${c.changedPart || '-'}</p>
                                </div>
                            </div>

                            <div class="bg-slate-900/60 p-4 rounded-2xl border border-white/5">
                                <span class="text-[7px] text-slate-500 font-black uppercase block mb-1">Son Aksiyon / Not</span>
                                <p class="text-[10px] font-medium text-slate-400 leading-relaxed italic line-clamp-2">${c.content || 'Not girilmemiş.'}</p>
                            </div>

                            <div class="flex justify-between items-center pt-2">
                                <div class="text-[8px] text-slate-600 font-bold uppercase tracking-widest">${c.date}</div>
                                <div class="flex gap-2">
                                    <button onclick="app.callCustomer('${phone}')" class="p-2 bg-green-500/20 text-green-400 rounded-xl hover:bg-green-500/30 transition-all">
                                        <i data-lucide="phone" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="app.deleteCustomer('${phone}')" class="p-2 bg-red-500/20 text-red-500 rounded-xl hover:bg-red-500/30 transition-all">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            },

            deleteCustomer: function (phone) {
                if (confirm("Bu müşteriyi siliyorum usta, emin misin?")) {
                    const customers = JSON.parse(localStorage.getItem(this.config.customersKey) || "{}");
                    delete customers[phone];
                    localStorage.setItem(this.config.customersKey, JSON.stringify(customers));
                    this.showCustomers();
                    this.loadStats();
                }
            },

            callCustomer: function (phone) {
                window.location.href = `tel:${phone}`;
            },

            libAddPart: function () {
                const model = document.getElementById('lib-model').value.trim().toUpperCase();
                const name = document.getElementById('lib-name').value.trim();
                const code = document.getElementById('lib-code').value.trim();
                const price = document.getElementById('lib-price').value.trim();

                if (!model || !name || !code) {
                    alert("Model, isim ve kod zorunlu usta!");
                    return;
                }

                const partsLib = JSON.parse(localStorage.getItem(this.config.partsLibKey) || "{}");
                if (!partsLib[model]) partsLib[model] = [];

                partsLib[model].push({ name, code, price });
                localStorage.setItem(this.config.partsLibKey, JSON.stringify(partsLib));

                alert("Parça kütüphaneye eklendi!");
                document.getElementById('lib-name').value = '';
                document.getElementById('lib-code').value = '';
                document.getElementById('lib-price').value = '';
                this.loadStats();
                this.libSearch(model);
            },

            libSearch: function (targetModel = null) {
                const query = (targetModel || document.getElementById('libSearchInput').value.trim()).toUpperCase();
                const resultsDiv = document.getElementById('libResults');

                if (!query) return;

                const partsLib = JSON.parse(localStorage.getItem(this.config.partsLibKey) || "{}");
                const found = partsLib[query] || [];

                if (found.length > 0) {
                    resultsDiv.innerHTML = found.map((p, idx) => `
                        <div class="glass-card p-5 rounded-3xl border-l-4 border-orange-500 flex justify-between items-center group">
                            <div>
                                <h4 class="text-sm font-black text-white uppercase">${p.name}</h4>
                                <div class="flex gap-3 mt-1">
                                    <span class="text-[9px] font-bold text-orange-400 tracking-widest">${p.code}</span>
                                    ${p.price ? `<span class="text-[9px] font-bold text-green-500">${p.price}</span>` : ''}
                                </div>
                            </div>
                            <button onclick="app.libDeletePart('${query}', ${idx})" class="p-2 text-slate-700 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="p-12 text-center opacity-30">
                            <p class="text-[10px] font-black uppercase tracking-widest italic">Bu model için kayıtlı parça yok.</p>
                        </div>`;
                }
                lucide.createIcons();
            },

            libDeletePart: function (model, index) {
                if (confirm("Parçayı siliyorum usta?")) {
                    const partsLib = JSON.parse(localStorage.getItem(this.config.partsLibKey) || "{}");
                    partsLib[model].splice(index, 1);
                    if (partsLib[model].length === 0) delete partsLib[model];
                    localStorage.setItem(this.config.partsLibKey, JSON.stringify(partsLib));
                    this.libSearch(model);
                    this.loadStats();
                }
            },

            loadSettings: function () {
                const settings = JSON.parse(localStorage.getItem(this.config.settingsKey) || '{"techName": "H. EMREHAN", "apiKey": "AIzaSyCsbBWTBmjl25QVW6cuJpF9WgrCfIbFv4I"}');
                document.getElementById('technician-name-label').textContent = `TEKNİSYEN: ${settings.techName}`;
                document.getElementById('profile-tech-name').textContent = settings.techName;
                document.getElementById('setting-tech-name').value = settings.techName;
                document.getElementById('setting-api-key').value = settings.apiKey;
                this.settings = settings;
            },

            saveSettings: function () {
                const techName = document.getElementById('setting-tech-name').value.trim() || "TEKNİSYEN";
                const apiKey = document.getElementById('setting-api-key').value.trim();
                const settings = { techName, apiKey };
                localStorage.setItem(this.config.settingsKey, JSON.stringify(settings));
                this.settings = settings;
                document.getElementById('technician-name-label').textContent = `TEKNİSYEN: ${techName}`;
                document.getElementById('profile-tech-name').textContent = techName;
                alert("Ayarlar kaydedildi usta!");
                this.switchPage('home');
            },

            loadStats: function () {
                const currentMonth = new Date().toLocaleDateString('tr-TR', { month: '2-digit', year: 'numeric' });
                let stats = JSON.parse(localStorage.getItem(this.config.statsKey) || '{"addresses": 0, "partsChanged": 0, "month": ""}');

                if (stats.month !== currentMonth) {
                    stats = { addresses: 0, partsChanged: 0, month: currentMonth };
                    localStorage.setItem(this.config.statsKey, JSON.stringify(stats));
                }

                document.getElementById('stat-addresses').textContent = stats.addresses;
                document.getElementById('stat-parts').textContent = stats.partsChanged;

                const customers = JSON.parse(localStorage.getItem(this.config.customersKey) || "{}");
                document.getElementById('stat-customers').textContent = Object.keys(customers).length;

                const partsLib = JSON.parse(localStorage.getItem(this.config.partsLibKey) || "{}");
                let partCount = 0;
                Object.values(partsLib).forEach(arr => partCount += arr.length);
                document.getElementById('stat-lib-parts').textContent = partCount;

                this.stats = stats;
            },

            incrementStat: function (key) {
                this.stats[key]++;
                localStorage.setItem(this.config.statsKey, JSON.stringify(this.stats));
                this.loadStats();
            },

            resetStats: function () {
                if (confirm("Metrikler sıfırlanacak emin misin usta?")) {
                    this.stats.addresses = 0;
                    this.stats.partsChanged = 0;
                    localStorage.setItem(this.config.statsKey, JSON.stringify(this.stats));
                    this.loadStats();
                }
            },

            togglePassword: function (id) {
                const input = document.getElementById(id);
                input.type = input.type === 'password' ? 'text' : 'password';
            },

            startVoiceSearch: function () {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Tarayıcın sesli aramayı desteklemiyor usta.");
                    return;
                }
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.onstart = () => {
                    document.getElementById('searchInput').placeholder = "Dinliyorum...";
                };
                recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript;
                    document.getElementById('searchInput').value = result;
                    this.searchSheets();
                };
                recognition.onend = () => {
                    document.getElementById('searchInput').placeholder = "Hata kodu (Örn: E15)...";
                };
                recognition.start();
            },

            switchPage: function (pageId) {
                const activePageId = (pageId === 'spareparts' || pageId === 'testmode' || pageId === 'testcodes') ? 'docs' : pageId;

                // Sayfa değişimi
                document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
                const target = document.getElementById(`page-${pageId}`);
                target.classList.remove('hidden');

                // Navigasyon stil güncelleme (sadece ana sayfalarda)
                document.querySelectorAll('nav button').forEach(btn => {
                    btn.classList.remove('active-nav');
                    btn.classList.add('text-slate-500');
                });

                const activeBtn = document.getElementById(`nav-${activePageId}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-slate-500');
                    activeBtn.classList.add('active-nav');
                }

                if (pageId === 'history') this.renderHistory();
                if (pageId === 'profile') this.loadStats();
                lucide.createIcons();
            },

            sendWhatsApp: function () {
                const phoneInput = document.getElementById('phoneInput');
                let phone = phoneInput.value.trim().replace(/\D/g, '');

                if (phone.length < 10) {
                    alert("Usta, numara eksik!");
                    phoneInput.focus();
                    return;
                }

                if (phone.length === 10) phone = '90' + phone;
                else if (phone.length === 11 && phone.startsWith('0')) phone = '9' + phone;

                const messageText = this.prepareMessage();
                const status = document.getElementById('current-status').value;
                const client = document.getElementById('customerName').value.trim() || phone;

                this.saveToHistory(`📞 ${status}`, client);
                this.saveToLastSent(phone, client, messageText);

                window.location.href = `https://wa.me/${phone}?text=${encodeURIComponent(messageText)}`;
            },

            setReminder: function () {
                const client = document.getElementById('customerName').value.trim();
                const phone = document.getElementById('phoneInput').value.trim();

                if (!client || !phone) {
                    alert("Önce müşteri adı ve telefonunu girmelisin usta!");
                    return;
                }

                if (Notification.permission !== "granted") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            this.scheduleReminder(client, phone);
                        } else {
                            alert("Bildirim izni vermezsen hatırlatamam usta.");
                        }
                    });
                } else {
                    this.scheduleReminder(client, phone);
                }
            },

            scheduleReminder: function (client, phone) {
                const reminders = JSON.parse(localStorage.getItem(this.config.remindersKey) || "[]");

                // 48 Saat Hatırlatıcı
                const dueTime = Date.now() + (48 * 60 * 60 * 1000);

                reminders.push({
                    id: Date.now(),
                    client,
                    phone,
                    dueTime,
                    status: 'PENDING'
                });

                localStorage.setItem(this.config.remindersKey, JSON.stringify(reminders));
                alert(`Tamamdır! ${client} için hatırlatıcı kuruldu.`);

                // Geçmişe de işaret koy (Eğer son kayıtsa)
                this.updateHistoryWithReminder(client);
            },

            checkReminders: function () {
                const reminders = JSON.parse(localStorage.getItem(this.config.remindersKey) || "[]");
                const now = Date.now();
                let updated = false;

                reminders.forEach(r => {
                    if (r.status === 'PENDING' && r.dueTime <= now) {
                        // Bildirim Gönder
                        this.sendNotification(`Hatırlatma: ${r.client}`, "48 Saat doldu! Müşteriye memnuniyet mesajı atma vakti geldi.");
                        r.status = 'SENT';
                        updated = true;

                        // Sesli uyarı
                        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                        audio.play().catch(e => console.log(e));
                    }
                });

                if (updated) {
                    localStorage.setItem(this.config.remindersKey, JSON.stringify(reminders));
                }
            },

            sendNotification: function (title, body) {
                if (Notification.permission === "granted") {
                    new Notification("ServisBot AI - Hatırlatıcı", {
                        body: body,
                        icon: 'icon.png',
                        vibrate: [200, 100, 200]
                    });
                }
            },

            updateHistoryWithReminder: function (client) {
                // Son geçmiş kaydını bul ve remind bayrağı ekle
                let history = JSON.parse(localStorage.getItem(this.config.storageKey) || "[]");
                const index = history.findIndex(h => h.client === client || h.val.includes(client));

                if (index !== -1) {
                    history[index].hasReminder = true;
                    localStorage.setItem(this.config.storageKey, JSON.stringify(history));
                    this.renderHistory();
                }
            },

            prepareMessage: function () {
                const client = document.getElementById('customerName').value.trim() || "Müşterimiz";
                let device = document.getElementById('deviceType').value.trim();
                let fee = document.getElementById('serviceFee').value.trim();
                const status = document.getElementById('current-status').value;
                const isSoft = document.getElementById('tone-toggle').checked;

                // Mini Güvenlik: Boşsa "---" koy
                if (!device) device = "---";
                if (!fee && (status === 'COMPLETED')) fee = "İşlem sonunda belirlenecek";
                else if (!fee) fee = "---";

                const toneKey = isSoft ? 'soft' : 'normal';
                let template = this.messageTemplates[status][toneKey];

                return template
                    .replace(/{client}/g, client)
                    .replace(/{device}/g, device)
                    .replace(/{price}/g, fee)
                    .replace(/{tech}/g, this.settings.techName);
            },

            copyWhatsAppText: function () {
                const msg = this.prepareMessage();
                navigator.clipboard.writeText(msg).then(() => {
                    alert("Mesaj panoya kopyalandı usta! İster yapıştır ister yolla.");
                });
            },

            saveToLastSent: function (phone, client, message) {
                let lastSent = JSON.parse(localStorage.getItem(this.config.lastSentKey) || "[]");

                // Aynı kişiye mükerrer kaydı önle (en başa al)
                lastSent = lastSent.filter(item => item.phone !== phone);

                lastSent.unshift({
                    phone,
                    client: client.length > 15 ? client.substring(0, 12) + '...' : client,
                    message,
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                });

                localStorage.setItem(this.config.lastSentKey, JSON.stringify(lastSent.slice(0, 5)));
                this.renderLastSent();
            },

            renderLastSent: function () {
                const list = document.getElementById('quick-resend-list');
                const area = document.getElementById('quick-resend-area');
                const data = JSON.parse(localStorage.getItem(this.config.lastSentKey) || "[]");

                if (data.length === 0) {
                    area.classList.add('hidden');
                    return;
                }

                area.classList.remove('hidden');
                list.innerHTML = data.map((item, idx) => `
                    <button onclick="app.quickResend(${idx})" 
                        class="flex-shrink-0 bg-white/5 border border-white/10 px-4 py-3 rounded-2xl flex flex-col gap-1 active:scale-95 transition-all text-left min-w-[100px]">
                        <span class="text-[9px] font-black text-white uppercase tracking-tighter truncate w-20">${item.client}</span>
                        <div class="flex items-center gap-1">
                            <span class="text-[7px] text-slate-500 font-bold">${item.time}</span>
                            <i data-lucide="send" class="w-2 h-2 text-blue-400"></i>
                        </div>
                    </button>
                `).join('');
                lucide.createIcons();
            },

            quickResend: function (idx) {
                const data = JSON.parse(localStorage.getItem(this.config.lastSentKey) || "[]");
                const item = data[idx];
                if (item) {
                    window.location.href = `https://wa.me/${item.phone}?text=${encodeURIComponent(item.message)}`;
                }
            },

            searchSheets: async function () {
                const query = document.getElementById('searchInput').value.trim().toUpperCase();
                const resultsDiv = document.getElementById('results');

                if (!query) return;

                resultsDiv.innerHTML = '<div class="loading-shimmer h-32 w-full rounded-[2.5rem]"></div>';

                try {
                    const csvData = await this.fetchWithFallback(this.config.sheetsUrl);
                    const rows = this.parseCSV(csvData);
                    const matchRow = rows.find(row => row.some(cell => (cell || '').toUpperCase().includes(query)));

                    if (matchRow) {
                        resultsDiv.innerHTML = `
                            <div class="bg-blue-600/10 border border-blue-500/20 p-7 rounded-[2.5rem] animate-in slide-in-from-bottom-5 duration-500">
                                <div class="flex justify-between items-start mb-5">
                                    <div>
                                        <div class="text-blue-400 text-[10px] font-black tracking-widest uppercase italic mb-1">HAFIZA VERİSİ BULUNDU</div>
                                        <div class="text-3xl font-black text-white tracking-tighter">${query}</div>
                                    </div>
                                    <div class="bg-blue-500 text-white text-[9px] font-black px-3 py-1 rounded-full shadow-lg shadow-blue-500/30">BSH GROUP</div>
                                </div>
                                <div class="space-y-4">
                                    <div class="bg-slate-900/60 p-5 rounded-3xl border border-white/5">
                                        <span class="text-[9px] text-slate-500 font-black uppercase block mb-2 tracking-widest">Hata Tanımı</span>
                                        <p class="text-sm font-bold text-slate-100 leading-relaxed">${(matchRow[3] || 'Tanımlama yapılmamış.').replace(/"/g, '')}</p>
                                    </div>
                                    <div class="bg-blue-500/20 p-5 rounded-3xl border border-blue-500/20 shadow-inner">
                                        <span class="text-[9px] text-blue-400 font-black uppercase block mb-2 tracking-widest">Teknisyen Aksiyonu</span>
                                        <p class="text-sm font-black text-blue-50">${(matchRow[5] || 'Standart kontrolleri sağla.').replace(/"/g, '')}</p>
                                    </div>
                                </div>
                            </div>`;
                        this.saveToHistory('🔍 Kod Sorgu', query);
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="p-8 bg-white/5 border border-white/5 rounded-[2.5rem] text-center">
                                <p class="text-slate-400 text-sm font-bold uppercase tracking-tighter">Dökümanda bu kod yok usta.</p>
                                <p class="text-[10px] text-slate-600 mt-2 font-bold uppercase tracking-widest">AI Desteğini Kullanabilirsin</p>
                            </div>`;
                    }
                    lucide.createIcons();
                } catch (e) {
                    resultsDiv.innerHTML = `
                        <div class="p-6 bg-red-500/10 border border-red-500/20 rounded-3xl text-center">
                            <p class="text-red-500 text-[10px] font-black uppercase tracking-widest italic mb-2">VERİ BAĞLANTI HATASI!</p>
                            <p class="text-[9px] text-slate-400 font-bold leading-relaxed uppercase">${e.message}</p>
                        </div>`;
                }
            },

            askGemini: async function () {
                const query = document.getElementById('searchInput').value.trim();
                const resultsDiv = document.getElementById('results');

                if (!query) {
                    alert("Önce bir arıza kodu veya belirti yaz usta!");
                    return;
                }

                resultsDiv.innerHTML = `
                    <div class="p-8 bg-indigo-500/10 border border-indigo-500/20 rounded-[2.5rem] flex items-center gap-5">
                        <div class="w-6 h-6 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-xs font-black text-indigo-400 uppercase tracking-widest italic">AI Analiz Ediyor...</span>
                    </div>`;

                const tryAi = async (modelName, proxy = null, apiVersion = 'v1beta') => {
                    const baseUrl = `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${this.settings.apiKey}`;
                    const url = proxy ? `${proxy}${encodeURIComponent(baseUrl)}` : baseUrl;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `Sen bir Bosch Siemens Profilo (BSH) teknik uzmanısın. Teknisyen ${this.settings.techName}'in şu sorusunu teknik bir dille, kısa ve çözüm odaklı madde madde yanıtla: "${query}".`
                                }]
                            }]
                        }),
                        signal: AbortSignal.timeout(12000) // 12 saniye limit
                    });
                    return response;
                };

                try {
                    // Protocol check for CORS warning
                    const isLocalFile = window.location.protocol === 'file:';

                    const proxies = [
                        'https://api.codetabs.com/v1/proxy?quest=',  // Stabil
                        'https://api.allorigins.win/raw?url=',        // Güvenilir
                        'https://corsproxy.io/?',                     // Alternatif
                        null                                          // Direkt (Sadece HTTPS/Server için)
                    ];

                    const models = [
                        { name: 'gemini-1.5-flash-latest', api: 'v1beta' },
                        { name: 'gemini-1.5-flash', api: 'v1' },
                        { name: 'gemini-1.5-pro', api: 'v1' }
                    ];

                    let response;
                    let lastError;
                    let successModel = null;

                    // Her proxy için modelleri dene
                    for (const proxy of proxies) {
                        if (successModel) break;

                        // Yerel dosyada direkt bağlantı genellikle başarısız olur, atla
                        if (isLocalFile && proxy === null) continue;

                        for (const modelObj of models) {
                            try {
                                console.log(`AI Deneniyor: ${modelObj.name} (${proxy ? 'Proxy' : 'Direkt'})`);
                                response = await tryAi(modelObj.name, proxy, modelObj.api);

                                if (response.ok) {
                                    successModel = modelObj.name;
                                    break;
                                } else {
                                    const errData = await response.json().catch(() => ({}));
                                    console.warn(`AI Sinyal Hatası (${modelObj.name}): ${response.status}`, errData);
                                    lastError = new Error(errData.error?.message || `HTTP ${response.status}`);
                                }
                            } catch (e) {
                                console.error(`AI Bağlantı Hatası (${modelObj.name}):`, e.message);
                                lastError = e;
                                continue;
                            }
                        }
                    }

                    if (!successModel) {
                        let errorMsg = lastError?.message || "Bağlantı kurulamadı.";
                        if (isLocalFile) {
                            errorMsg += " (Not: Uygulamayı 'file://' üzerinden çalıştırdığınız için CORS engeli oluşuyor olabilir. GitHub sayfasından kullanmayı deneyin.)";
                        }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        throw new Error("AI geçerli bir yanıt oluşturamadı.");
                    }

                    let aiText = data.candidates[0].content.parts[0].text;
                    aiText = aiText.replace(/\*/g, '').replace(/#/g, '');

                    resultsDiv.innerHTML = `
                        <div class="bg-indigo-600/10 border border-indigo-500/20 p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                            <div class="absolute -top-10 -right-10 opacity-5">
                                <i data-lucide="sparkles" class="w-40 h-40"></i>
                            </div>
                            <div class="flex items-center gap-3 mb-5">
                                <div class="p-2 bg-indigo-500/20 rounded-lg text-indigo-400">
                                    <i data-lucide="brain-circuit" class="w-4 h-4"></i>
                                </div>
                                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">AI Teknik Raporu</span>
                                <span class="text-[8px] text-slate-600 italic">(${successModel})</span>
                            </div>
                            <div class="text-sm leading-relaxed font-bold text-slate-200 whitespace-pre-line">${aiText}</div>
                        </div>`;
                    this.saveToHistory('🧠 AI Analiz', query);
                    lucide.createIcons();
                } catch (e) {
                    console.error("AI_FINAL_ERROR:", e);
                    resultsDiv.innerHTML = `
                        <div class="p-8 bg-gradient-to-br from-red-500/10 to-orange-500/10 border border-red-500/30 rounded-[2.5rem]">
                            <div class="text-center mb-5">
                                <i data-lucide="wifi-off" class="w-12 h-12 mx-auto text-red-500 mb-3"></i>
                                <p class="text-red-400 text-xs font-black uppercase tracking-widest mb-2">AI Servisi Geçici Olarak Erişilemiyor</p>
                                <p class="text-[10px] text-slate-400 font-semibold">${e.message}</p>
                            </div>
                            
                            <div class="bg-slate-900/50 p-6 rounded-2xl border border-white/5">
                                <div class="flex items-center gap-2 mb-4">
                                    <i data-lucide="lightbulb" class="w-4 h-4 text-amber-400"></i>
                                    <p class="text-[10px] text-amber-400 font-black uppercase">Çözüm Önerileri</p>
                                </div>
                                <div class="space-y-3 text-[10px] text-slate-300">
                                    <div class="flex items-start gap-2">
                                        <span class="text-green-400 font-black">1.</span>
                                        <span>Uygulamayı <strong>GitHub üzerinden</strong> (https://...) çalıştırın. Yerel dosyalarda CORS engeli sık yaşanır.</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-blue-400 font-black">2.</span>
                                        <span>API anahtarınızın doğru ve aktif olduğundan emin olun.</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-blue-400 font-black">3.</span>
                                        <span>İnternet bağlantınızı kontrol edin veya bir süre sonra tekrar deneyin.</span>
                                    </div>
                                </div>
                                <div class="mt-5 pt-4 border-t border-white/5 flex gap-2">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                                       class="flex-1 bg-blue-500/10 border border-blue-500/20 py-3 rounded-xl text-[9px] font-bold text-blue-400 text-center">
                                        Anahtar Al
                                    </a>
                                    <button onclick="app.switchPage('settings')" 
                                       class="flex-1 bg-white/5 border border-white/10 py-3 rounded-xl text-[9px] font-bold text-slate-400">
                                        Ayarlara Git
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    lucide.createIcons();
                }
            },

            saveToHistory: function (type, val, clientOverride = null) {
                let history = JSON.parse(localStorage.getItem(this.config.storageKey) || "[]");

                // Detay verileri formdan çek
                const device = document.getElementById('deviceType').value.trim() || '---';
                const noteContent = document.getElementById('note-content').value.trim() || 'Not yok.';
                const client = clientOverride || document.getElementById('customerName').value.trim() || 'Bilinmeyen Müşteri';

                const newItem = {
                    type,
                    val,
                    client,     // Müşteri İsmi (Ayrı tutalım)
                    device,     // Cihaz Detayı
                    note: noteContent,   // Ekstra Notlar
                    hasReminder: false,  // VarsayılanReminder yok
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString('tr-TR')
                };
                history.unshift(newItem);
                localStorage.setItem(this.config.storageKey, JSON.stringify(history.slice(0, 40)));
            },

            showHistoryDetail: function (idx) {
                const data = JSON.parse(localStorage.getItem(this.config.storageKey) || "[]");
                const item = data[idx];
                if (!item) return;

                document.getElementById('modal-date').textContent = `${item.date} - ${item.time}`;
                document.getElementById('modal-client').textContent = item.client || item.val;
                document.getElementById('modal-device').textContent = item.device || "---";
                document.getElementById('modal-type').textContent = item.type;
                document.getElementById('modal-note').textContent = item.note || "Ek not bulunmuyor.";

                document.getElementById('history-detail-modal').classList.remove('hidden');
            },

            renderHistory: function () {
                const list = document.getElementById('historyList');
                const data = JSON.parse(localStorage.getItem(this.config.storageKey) || "[]");

                if (!data.length) {
                    list.innerHTML = `
                        <div class="p-24 text-center">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto text-slate-800 mb-4"></i>
                            <p class="opacity-30 text-[10px] font-black uppercase tracking-widest italic">Henüz Bir Kayıt Yok</p>
                        </div>`;
                    return;
                }

                list.innerHTML = data.map((item, idx) => `
                    <div onclick="app.showHistoryDetail(${idx})" 
                        class="glass-card p-5 rounded-3xl flex justify-between items-center border-l-4 ${item.type.includes('📞') ? 'border-green-500' : 'border-indigo-500'} group cursor-pointer active:scale-[0.98] transition-all relative overflow-hidden">
                        
                        ${item.hasReminder ? `<div class="absolute top-0 right-0 bg-blue-600 p-2 rounded-bl-2xl shadow-lg"><i data-lucide="bell" class="w-3 h-3 text-white animate-pulse"></i></div>` : ''}

                        <div>
                            <p class="text-[9px] font-black opacity-30 uppercase tracking-widest mb-1 flex items-center gap-2">
                                ${item.type}
                            </p>
                            <p class="font-bold text-white text-base tracking-tight">${item.client || item.val}</p>
                            ${item.device ? `<p class="text-[9px] text-slate-500 font-bold uppercase mt-1">${item.device}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] font-black opacity-40 bg-slate-900/80 px-3 py-1.5 rounded-xl border border-white/5 italic">${item.time}</span>
                        </div>
                    </div>`).join('');
                lucide.createIcons();
            },

            searchTestMode: async function () {
                const query = document.getElementById('testModeSearchInput').value.trim().toUpperCase();
                const resultsDiv = document.getElementById('testModeResults');

                if (!query) {
                    resultsDiv.innerHTML = `
                        <div class="p-6 bg-yellow-500/10 border border-yellow-500/20 rounded-3xl text-center">
                            <p class="text-yellow-400 text-xs font-bold uppercase">Model numarası veya cihaz tipi gir!</p>
                        </div>`;
                    return;
                }

                resultsDiv.innerHTML = '<div class="loading-shimmer h-32 w-full rounded-[2.5rem]"></div>';

                try {
                    const csvData = await this.fetchWithFallback(this.config.testModeCsv);
                    const allRows = this.parseCSV(csvData);
                    const dataRows = allRows.slice(1); // Başlığı atla

                    // Arama yap
                    const matchRow = dataRows.find(row => {
                        const cihazTipi = (row[0] || '').toUpperCase();
                        const modeller = (row[1] || '').toUpperCase();
                        return cihazTipi.includes(query) || modeller.includes(query);
                    });

                    if (matchRow) {
                        const cihazTipi = (matchRow[0] || '').trim();
                        const modelSeri = (matchRow[1] || '').trim();
                        const girisKombinasyonuRaw = (matchRow[2] || '').trim();
                        const testAmaci = (matchRow[3] || '').trim();

                        // Giriş talimatlarını adımlara göre ayır
                        const steps = girisKombinasyonuRaw
                            .split(/\n+/)
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                const stepMatch = line.match(/^(\d+)\.\s(.*)/);
                                if (stepMatch) {
                                    const stepNum = stepMatch[1];
                                    const stepText = stepMatch[2];
                                    return `
                                        <div class="flex gap-4 p-4 bg-slate-900/40 rounded-2xl border border-white/5 group hover:border-green-500/30 transition-all">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 font-black text-xs shadow-inner">
                                                ${stepNum}
                                            </div>
                                            <p class="text-sm font-bold text-slate-200 leading-relaxed pt-1">${stepText}</p>
                                        </div>`;
                                } else {
                                    return `
                                        <div class="p-4 bg-slate-900/20 rounded-2xl border border-white/5 ml-12">
                                            <p class="text-xs font-semibold text-slate-400 leading-relaxed">${line}</p>
                                        </div>`;
                                }
                            }).join('');

                        resultsDiv.innerHTML = `
                            <div class="bg-green-600/10 border border-green-500/20 p-8 rounded-[2.5rem] animate-in slide-in-from-bottom-5 duration-500 shadow-2xl">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <div class="text-green-400 text-[10px] font-black tracking-widest uppercase italic mb-1">DETAYLI TALİMAT BULUNDU</div>
                                        <div class="text-2xl font-black text-white tracking-tighter leading-tight">${cihazTipi}</div>
                                        <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase opacity-60">${modelSeri}</p>
                                    </div>
                                    <div class="bg-green-500 text-white text-[9px] font-black px-4 py-1.5 rounded-full shadow-lg shadow-green-500/30">BSH GROUP</div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="bg-slate-950/50 p-6 rounded-3xl border border-white/5">
                                        <span class="text-[9px] text-green-400 font-black uppercase block mb-4 tracking-widest flex items-center gap-2">
                                            <i data-lucide="list-ordered" class="w-3 h-3"></i> GİRİŞ ADIMLARI
                                        </span>
                                        <div class="space-y-3">
                                            ${steps}
                                        </div>
                                    </div>
                                    
                                    ${testAmaci ? `
                                    <div class="bg-green-500/10 p-5 rounded-2xl border border-green-500/20 flex gap-3">
                                        <i data-lucide="info" class="w-5 h-5 text-green-400 flex-shrink-0"></i>
                                        <div>
                                            <span class="text-[9px] text-green-400 font-black uppercase block mb-1 tracking-widest">TEKNİK NOT / AMAÇ</span>
                                            <p class="text-xs font-bold text-green-50 opacity-90">${testAmaci}</p>
                                        </div>
                                    </div>` : ''}
                                </div>
                            </div>`;

                        this.saveToHistory('🔧 Test Modu', query);
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="p-8 bg-white/5 border border-white/5 rounded-[2.5rem] text-center">
                                <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-slate-600 mb-3"></i>
                                <p class="text-slate-400 text-sm font-bold uppercase tracking-tighter mb-2">Bu model veritabanında bulunamadı</p>
                                <p class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">Aşağıdaki genel talimatları kullan</p>
                            </div>`;
                    }
                    lucide.createIcons();
                } catch (e) {
                    resultsDiv.innerHTML = `
                        <div class="p-6 bg-red-500/10 border border-red-500/20 rounded-3xl text-center">
                            <p class="text-red-500 text-[10px] font-black uppercase tracking-widest italic mb-2">VERİ BAĞLANTI HATASI!</p>
                            <p class="text-[9px] text-slate-400 font-bold leading-relaxed uppercase">${e.message}</p>
                        </div>`;
                }
            },

            loadTestCodes: async function (category) {
                const resultsDiv = document.getElementById('testCodesResults');
                resultsDiv.innerHTML = '<div class="loading-shimmer h-64 w-full rounded-[2.5rem]"></div>';

                try {
                    const csvData = await this.fetchWithFallback(this.config.testCodesCsv);
                    const rows = this.parseCSV(csvData);

                    const filtered = rows.filter(row => row[0] && row[0].includes(category));

                    if (filtered.length > 0) {
                        resultsDiv.innerHTML = `
                            <div class="p-2">
                                <span class="text-[10px] font-black text-orange-400 uppercase tracking-[0.2em] mb-4 block">${category} TEST PROGRAMLARI</span>
                                <div class="space-y-3">
                                    ${filtered.map(row => `
                                        <div class="glass-card p-5 rounded-3xl border-l-4 border-orange-500 flex flex-col gap-2">
                                            <div class="flex justify-between items-center">
                                                <span class="text-2xl font-black text-white tracking-tighter">${row[1]}</span>
                                                <span class="text-[10px] font-black bg-orange-500/20 text-orange-400 px-3 py-1 rounded-full uppercase">${(row[2] || '').replace(/"/g, '')}</span>
                                            </div>
                                            <p class="text-xs font-bold text-slate-400 leading-relaxed">${(row[3] || '').replace(/"/g, '')}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>`;
                    } else {
                        resultsDiv.innerHTML = `<div class="p-12 text-center text-slate-500 uppercase font-black text-xs">Bu kategori için veri bulunamadı.</div>`;
                    }
                    lucide.createIcons();
                } catch (e) {
                    resultsDiv.innerHTML = `<div class="p-12 text-center text-red-500 uppercase font-black text-xs">Hata: ${e.message}</div>`;
                }
            },

            clearHistory: function () {
                if (confirm("Tüm günlükleri siliyorum usta, emin misin?")) {
                    localStorage.removeItem(this.config.storageKey);
                    this.renderHistory();
                }
            }
        };

        // Uygulamayı Başlat
        window.onload = () => {
            app.init();

            // Service Worker Kaydı (PWA yükleme desteği için)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(reg => console.log('ServisBot SW Kayıt Başarılı'))
                        .catch(err => console.log('ServisBot SW Kayıt Hatası', err));
                });
            }
        };
    </script>
</body>

</html>